{% extends "base.html" %}
{% load static %}
{% load humanize %} {# For intcomma if needed, though not used in current stat fields #}

{% block title %} {{ block.super }} - {{ page_title }}{% endblock %}

{% block content %}
<div class="w3-container w3-padding-small">
    {# Page Title - Plain like unprofitable_channels.html #}
    <h2>{{ page_title }}</h2>

    {# Filter Form - Placed directly under the title #}
    <div class="w3-container w3-padding-small"> {# Added padding-small for a bit of spacing #}
        <form method="get">
            <label for="timeframe">Timeframe:</label>
            <select name="timeframe" id="timeframe" class="w3-select w3-border w3-round" style="width:auto; display:inline-block; margin-right:15px;" onchange="this.form.submit()">
                {% for key, value in timeframe_options.items %}
                <option value="{{ key }}" {% if key == selected_timeframe %}selected{% endif %}>{{ value }}</option>
                {% endfor %}
            </select>

            <label for="alias" style="margin-left:10px;">Filter by Alias:</label>
            <input type="text" name="alias" id="alias" class="w3-input w3-border w3-round" style="width:auto; display:inline-block;" value="{{ alias_filter_query }}">
            
            <button type="submit" class="w3-button w3-blue w3-round w3-padding-small" style="margin-left:10px;">Filter</button>
            <a href="{% url 'peer-offline-report' %}" class="w3-button w3-grey w3-round w3-padding-small" style="margin-left:5px;">Reset</a>
        </form>
    </div>

    {% if peer_stats %}
    <div class="w3-container w3-padding-small" style="overflow-x:auto;">
        {# Table styling to match unprofitable_channels.html more closely #}
        {# Retaining w3-centered for data, headers will follow if not overridden by th specific styles #}
        <table id="peerOfflineReportTable" class="w3-table-all w3-centered w3-hoverable"> 
            <thead>
                <tr> 
                    <th onclick="sortTable(event.target, 0, 'String', 1)">Alias</th>
                    <th onclick="sortTable(event.target, 1, 'String', 1)">Current Status</th>
                    <th onclick="sortTable(event.target, 2, 'float', 0)">AVG Offline Hours</th>
                    <th onclick="sortTable(event.target, 3, 'float', 0)">SUM Offline Hours</th>
                    <th onclick="sortTable(event.target, 4, 'int', 0)">Offline Count</th>
                </tr>
            </thead>
            <tbody>
                {% for peer in peer_stats %}
                <tr>
                    <td>
                        <a href="{% url 'channel' %}?chan_id={{ peer.chan_id }}" title="View Channel Details for {{ peer.channel_alias }}" target="_blank">
                            {{ peer.channel_alias }}
                        </a>
                    </td>
                    <td class="w3-center"> {# Explicitly center status icon #}
                        {% if peer.currently_offline %}
                        <span title="Offline" style="color:red; font-size:1.2em;">&#10060;</span>
                        {% else %}
                        <span title="Online" style="color:green; font-size:1.0em;">&#9989;</span>
                        {% endif %}
                    </td>
                    <td data-value="{{ peer.avg_offline_hours }}">{{ peer.avg_offline_hours | floatformat:2 }}</td>
                    <td data-value="{{ peer.total_offline_hours }}">{{ peer.total_offline_hours | floatformat:2 }}</td>
                    <td data-value="{{ peer.offline_count }}">{{ peer.offline_count }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="w3-container w3-padding w3-center">
        <p>No peer offline data found for the selected criteria.</p>
    </div>
    {% endif %}
    <div class="w3-container w3-padding-small w3-small w3-text-grey"> {# Footer styling like unprofitable_channels's explanation box #}
        Data based on peer connection events for the {{ selected_timeframe }} period.
        Default sort by SUM Offline Hours (descending). Click headers to re-sort.
    </div>
</div>

<script>
// Adopted sortTable function similar to unprofitable_channels.html
function sortTable(clickedHeaderElement, columnIndex, type, initialDirAsc) {
    const table = document.getElementById("peerOfflineReportTable");
    let rows = Array.from(table.rows).slice(1); 
    let currentSortDir = clickedHeaderElement.dataset.sortDir || (initialDirAsc ? "asc" : "desc");
    let D; 

    if (clickedHeaderElement.classList.contains('sorting')) {
        D = (currentSortDir === "asc") ? -1 : 1; 
        clickedHeaderElement.dataset.sortDir = (D === 1) ? "asc" : "desc";
    } else {
        D = initialDirAsc ? 1 : -1; 
        clickedHeaderElement.dataset.sortDir = initialDirAsc ? "asc" : "desc";
    }
    
    const headers = table.getElementsByTagName("TH");
    for (let i = 0; i < headers.length; i++) {
        headers[i].innerHTML = headers[i].innerHTML.replace(/ [↑↓]$/, ""); 
        if (headers[i] !== clickedHeaderElement) {
            headers[i].classList.remove('sorting');
            delete headers[i].dataset.sortDir;
        }
    }
    
    clickedHeaderElement.classList.add('sorting');
    // Ensure existing content isn't duplicated if sortTable is called multiple times on same header before full page refresh
    let baseHTML = clickedHeaderElement.innerHTML.replace(/ [↑↓]$/, "");
    clickedHeaderElement.innerHTML = baseHTML + (D === 1 ? " ↑" : " ↓");


    rows.sort((a, b) => {
        let valA = a.cells[columnIndex].dataset.value || a.cells[columnIndex].textContent.trim();
        let valB = b.cells[columnIndex].dataset.value || b.cells[columnIndex].textContent.trim();

        if (type === 'float') {
            valA = parseFloat(valA);
            valB = parseFloat(valB);
        } else if (type === 'int') {
            valA = parseInt(valA, 10);
            valB = parseInt(valB, 10);
        } else if (type === 'String') {
            valA = valA.toLowerCase();
            valB = valB.toLowerCase();
        }
        
        if (valA < valB) return -1 * D;
        if (valA > valB) return 1 * D;
        return 0;
    });

    const tbody = table.tBodies[0];
    tbody.innerHTML = ""; 
    rows.forEach(row => tbody.appendChild(row)); 
}

document.addEventListener('DOMContentLoaded', function() {
    const headers = document.getElementById("peerOfflineReportTable").getElementsByTagName('th');
    if (headers.length > 3) { 
        const sumOfflineTh = headers[3]; // SUM Offline Hours column
        sumOfflineTh.dataset.sortDir = 'desc'; 
        sumOfflineTh.classList.add('sorting');    
        // Ensure existing content isn't duplicated if script runs multiple times or header has complex content
        let baseHTML = sumOfflineTh.innerHTML.replace(/ [↑↓]$/, "");
        sumOfflineTh.innerHTML = baseHTML + " ↓";
    }
});
</script>
{% endblock %}